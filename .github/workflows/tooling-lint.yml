name: tooling-lint
on: [push, pull_request]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pinned

      - name: Install linters
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y shellcheck ripgrep

          # shfmt (pinned)
          sudo curl -fsSL -o /usr/local/bin/shfmt https://github.com/mvdan/sh/releases/download/v3.12.0/shfmt_v3.12.0_linux_amd64
          sudo chmod +x /usr/local/bin/shfmt

          # actionlint (pinned)
          curl -fsSL -o /tmp/actionlint.tar.gz https://github.com/rhysd/actionlint/releases/download/v1.7.10/actionlint_1.7.10_linux_amd64.tar.gz
          sudo tar -C /usr/local/bin -xzf /tmp/actionlint.tar.gz actionlint
          sudo chmod +x /usr/local/bin/actionlint

      - name: shfmt (check)
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t files < <(git ls-files '*.sh')
          if (( ${#files[@]} == 0 )); then
            echo "No .sh files to format-check."
            exit 0
          fi
          shfmt -i 2 -bn -ci -d "${files[@]}"

      - name: ShellCheck
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t files < <(git ls-files '*.sh')
          if (( ${#files[@]} == 0 )); then
            echo "No .sh files to check."
            exit 0
          fi
          shellcheck "${files[@]}"

      - name: actionlint
        shell: bash
        run: |
          set -euo pipefail
          actionlint -color
